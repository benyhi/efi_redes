<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Tracker Simple</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .login-box { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-top: 10vh; }
        .dashboard { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-top: 20px; }
        
        h1 { text-align: center; color: #333; margin-bottom: 30px; }
        h2 { color: #555; margin-bottom: 20px; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; color: #555; font-weight: bold; }
        input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
        input:focus { outline: none; border-color: #667eea; }
        
        .btn { width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }
        .btn:hover { background: #5a6fd8; }
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }
        
        .status { padding: 15px; margin: 15px 0; border-radius: 8px; text-align: center; font-weight: bold; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        #map { height: 400px; border-radius: 10px; margin: 20px 0; }
        .hidden { display: none !important; }
        
        .coords-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .coords-info h3 { color: #495057; margin-bottom: 10px; }
        .coord-item { margin: 5px 0; font-family: monospace; }
        
        /* Log panel styles */
        .log-panel { 
            background: #f8f9fa; 
            border-radius: 8px; 
            margin: 15px 0; 
            overflow: hidden;
        }
        
        .log-header {
            background: #495057;
            color: white;
            padding: 10px 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .log-content {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin: 2px 0;
            line-height: 1.3;
        }
        
        .log-timestamp { color: #ffff00; }
        .log-level { 
            padding: 1px 4px;
            border-radius: 2px;
            font-weight: bold;
            margin: 0 5px;
        }
        .log-level.info { background: #007bff; color: white; }
        .log-level.success { background: #28a745; color: white; }
        .log-level.warning { background: #ffc107; color: black; }
        .log-level.error { background: #dc3545; color: white; }
        
        .log-clear-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .log-clear-btn:hover {
            background: #5a6268;
        }
        
        /* Styles para toggle entre login y registro */
        .auth-toggle {
            text-align: center;
            margin-top: 15px;
            color: #666;
        }
        
        .auth-toggle a {
            color: #667eea;
            text-decoration: none;
            font-weight: bold;
        }
        
        .auth-toggle a:hover {
            text-decoration: underline;
        }
        
        .register-fields {
            display: none;
        }
        
        .register-fields.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Secci√≥n de Login -->
        <div id="loginSection">
            <div class="login-box">
                <h1 id="authTitle">üåç GPS Tracker Simple</h1>
                <form id="authForm">
                    <div class="form-group">
                        <label for="username">Usuario:</label>
                        <input type="text" id="username" value="admin" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Contrase√±a:</label>
                        <input type="password" id="password" value="admin123" required>
                    </div>
                    <div class="form-group register-fields" id="registerFields">
                        <label for="email">Email (opcional):</label>
                        <input type="email" id="email" placeholder="ejemplo@correo.com">
                    </div>
                    <button type="submit" class="btn" id="authSubmitBtn">Iniciar Sesi√≥n</button>
                </form>
                <div class="auth-toggle">
                    <span id="authToggleText">¬øNo tienes cuenta? </span>
                    <a href="#" id="authToggleLink">Reg√≠strate aqu√≠</a>
                </div>
                <div id="loginStatus"></div>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="hidden">
            <div class="dashboard">
                <h2>üìç GPS Tracker Dashboard</h2>
                <button id="logoutBtn" class="btn btn-danger">Cerrar Sesi√≥n</button>
                <div id="statusDiv"></div>
                
                <div class="coords-info">
                    <h3>üìä Mi Ubicaci√≥n Actual:</h3>
                    <div id="myLocation">Detectando ubicaci√≥n...</div>
                </div>

                <div id="map"></div>
                
                <div class="coords-info">
                    <h3>üë• Dispositivos Conectados:</h3>
                    <div id="devicesList">No hay dispositivos conectados</div>
                </div>
                
                <!-- Panel de Log en Tiempo Real -->
                <div class="log-panel">
                    <div class="log-header">
                        üìã Log de Actividad en Tiempo Real
                        <button class="log-clear-btn" onclick="clearLog()">Limpiar</button>
                    </div>
                    <div class="log-content" id="logContent">
                        <div class="log-entry">
                            <span class="log-timestamp">[Esperando...]</span>
                            <span class="log-level info">INFO</span>
                            Sistema iniciando...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let socket;
        let map;
        let markers = {};
        let myMarker;
        let isAuthenticated = false;
        let watchId = null;
        let deviceId;
        let deviceName;
        let logEntries = [];
        const maxLogEntries = 50;

        // Funci√≥n para generar ID √∫nico basado en caracter√≠sticas del dispositivo
        function generateDeviceId() {
            // Usar caracter√≠sticas del navegador para generar un ID m√°s consistente
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('Device fingerprint', 2, 2);
            
            const fingerprint = [
                navigator.userAgent,
                navigator.language,
                screen.width + 'x' + screen.height,
                new Date().getTimezoneOffset(),
                canvas.toDataURL()
            ].join('|');
            
            // Generar hash simple del fingerprint
            let hash = 0;
            for (let i = 0; i < fingerprint.length; i++) {
                const char = fingerprint.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convertir a 32bit
            }
            
            // Simular formato MAC-like
            const mac = Math.abs(hash).toString(16).padStart(12, '0');
            return mac.match(/.{2}/g).join(':').toUpperCase().substring(0, 17);
        }

        // Funci√≥n para generar nombre del dispositivo
        function generateDeviceName() {
            const platform = navigator.platform || 'Unknown';
            const browser = getBrowserInfo();
            return `${platform}-${browser}`;
        }

        function getBrowserInfo() {
            const ua = navigator.userAgent;
            if (ua.includes('Chrome')) return 'Chrome';
            if (ua.includes('Firefox')) return 'Firefox';
            if (ua.includes('Safari')) return 'Safari';
            if (ua.includes('Edge')) return 'Edge';
            return 'Browser';
        }

        // Inicializar identificadores del dispositivo
        deviceId = generateDeviceId();
        deviceName = generateDeviceName();

        // Elementos DOM
        const loginSection = document.getElementById('loginSection');
        const dashboard = document.getElementById('dashboard');
        const authForm = document.getElementById('authForm');
        const authTitle = document.getElementById('authTitle');
        const authSubmitBtn = document.getElementById('authSubmitBtn');
        const authToggleText = document.getElementById('authToggleText');
        const authToggleLink = document.getElementById('authToggleLink');
        const registerFields = document.getElementById('registerFields');
        const loginStatus = document.getElementById('loginStatus');
        const statusDiv = document.getElementById('statusDiv');
        const myLocation = document.getElementById('myLocation');
        const devicesList = document.getElementById('devicesList');
        const logoutBtn = document.getElementById('logoutBtn');
        const logContent = document.getElementById('logContent');
        
        // Estado de autenticaci√≥n
        let isRegistering = false;

        // Funci√≥n de logging
        function addLog(level, message, details = '') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp,
                level,
                message,
                details
            };
            
            logEntries.unshift(logEntry);
            
            // Mantener solo las √∫ltimas entradas
            if (logEntries.length > maxLogEntries) {
                logEntries = logEntries.slice(0, maxLogEntries);
            }
            
            updateLogDisplay();
            
            // Tambi√©n log en consola
            console.log(`[${timestamp}] [${level.toUpperCase()}] ${message}`, details);
        }

        function updateLogDisplay() {
            logContent.innerHTML = logEntries.slice().reverse().map(entry => `
                <div class="log-entry">
                    <span class="log-timestamp">[${entry.timestamp}]</span>
                    <span class="log-level ${entry.level}">${entry.level.toUpperCase()}</span>
                    ${entry.message}
                    ${entry.details ? '<br>   ' + entry.details : ''}
                </div>
            `).join('');
        }

        function clearLog() {
            logEntries = [];
            updateLogDisplay();
            addLog('info', 'Log limpiado por el usuario');
        }

        // Inicializar mapa
        function initMap() {
            map = L.map('map').setView([-34.6037, -58.3816], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            addLog('success', 'Mapa inicializado correctamente');
        }

        // Mostrar mensaje
        function showMessage(element, message, type) {
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => element.innerHTML = '', 5000);
        }

        // Toggle entre login y registro
        function toggleAuthMode() {
            isRegistering = !isRegistering;
            
            if (isRegistering) {
                authTitle.textContent = 'üìù Registro de Usuario';
                authSubmitBtn.textContent = 'Registrarse';
                authToggleText.textContent = '¬øYa tienes cuenta? ';
                authToggleLink.textContent = 'Inicia sesi√≥n aqu√≠';
                registerFields.classList.add('show');
                
                // Limpiar valores predeterminados
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                
                addLog('info', 'Cambiado a modo registro');
            } else {
                authTitle.textContent = 'üåç GPS Tracker Simple';
                authSubmitBtn.textContent = 'Iniciar Sesi√≥n';
                authToggleText.textContent = '¬øNo tienes cuenta? ';
                authToggleLink.textContent = 'Reg√≠strate aqu√≠';
                registerFields.classList.remove('show');
                
                // Restaurar valores predeterminados
                document.getElementById('username').value = 'admin';
                document.getElementById('password').value = 'admin123';
                
                addLog('info', 'Cambiado a modo login');
            }
        }

        // Autenticaci√≥n HTTPS
        async function authenticate(username, password) {
            addLog('info', `Intentando autenticaci√≥n para usuario: ${username}`);
            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    addLog('success', 'Autenticaci√≥n exitosa');
                    addLog('info', 'Informaci√≥n del dispositivo', 
                        `MAC: ${deviceId} | Nombre: ${deviceName} | Plataforma: ${navigator.platform}`);
                    showMessage(loginStatus, '‚úÖ Autenticaci√≥n exitosa', 'success');
                    showDashboard();
                    connectSocket();
                } else {
                    addLog('error', 'Autenticaci√≥n fallida', result.error);
                    showMessage(loginStatus, '‚ùå ' + result.error, 'error');
                }
            } catch (error) {
                addLog('error', 'Error de conexi√≥n durante autenticaci√≥n', error.message);
                showMessage(loginStatus, '‚ùå Error de conexi√≥n', 'error');
            }
        }

        // Registro de usuario
        async function registerUser(username, password, email) {
            addLog('info', `Intentando registro para usuario: ${username}`);
            try {
                const response = await fetch('/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, email })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    addLog('success', 'Usuario registrado exitosamente');
                    showMessage(loginStatus, '‚úÖ Usuario registrado. Ahora puedes iniciar sesi√≥n', 'success');
                    
                    // Cambiar autom√°ticamente a modo login
                    setTimeout(() => {
                        toggleAuthMode();
                        document.getElementById('username').value = username;
                        document.getElementById('password').value = password;
                    }, 2000);
                } else {
                    addLog('error', 'Error en registro', result.error);
                    showMessage(loginStatus, '‚ùå ' + result.error, 'error');
                }
            } catch (error) {
                addLog('error', 'Error de conexi√≥n durante registro', error.message);
                showMessage(loginStatus, '‚ùå Error de conexi√≥n', 'error');
            }
        }

        // Mostrar dashboard
        function showDashboard() {
            loginSection.classList.add('hidden');
            dashboard.classList.remove('hidden');
            isAuthenticated = true;
            addLog('info', 'Dashboard mostrado, inicializando componentes...');
            initMap();
            setTimeout(() => startGPSTracking(), 1000);
        }

        // Mostrar login
        function showLogin() {
            dashboard.classList.add('hidden');
            loginSection.classList.remove('hidden');
            isAuthenticated = false;
            stopGPSTracking();
            addLog('info', 'Sesi√≥n cerrada, regresando al login');
        }

        // Conectar Socket.IO
        function connectSocket() {
            addLog('info', 'Conectando a Socket.IO...');
            socket = io();
            
            socket.on('connect', () => {
                addLog('success', `Socket.IO conectado con ID: ${socket.id}`);
                showMessage(statusDiv, 'üîó Conectado al servidor', 'success');
            });

            socket.on('disconnect', () => {
                addLog('warning', 'Socket.IO desconectado');
                showMessage(statusDiv, '‚ùå Desconectado del servidor', 'error');
            });

            socket.on('coordinates_update', (data) => {
                const deviceCount = Object.keys(data).length;
                addLog('info', `Actualizaci√≥n de coordenadas recibida`, `${deviceCount} dispositivos activos`);
                updateMap(data);
                updateDevicesList(data);
            });
        }

        // GPS Tracking
        let locationLogger;
        let lastKnownLocation = null;

        function startGPSTracking() {
            if (!navigator.geolocation) {
                addLog('error', 'Geolocalizaci√≥n no disponible en este navegador');
                showMessage(statusDiv, '‚ùå Geolocalizaci√≥n no disponible', 'error');
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            };

            addLog('info', 'Iniciando seguimiento GPS...', 
                `Device MAC: ${deviceId} | Nombre: ${deviceName}`);

            watchId = navigator.geolocation.watchPosition(
                sendLocation,
                handleLocationError,
                options
            );

            // Iniciar logger de ubicaci√≥n cada 2 segundos
            startLocationLogger();

            showMessage(statusDiv, 'üìç GPS tracking activado', 'success');
        }

        function startLocationLogger() {
            locationLogger = setInterval(() => {
                if (lastKnownLocation) {
                    const now = new Date();
                    addLog('info', 'üîÑ Log autom√°tico de ubicaci√≥n', 
                        `Lat: ${lastKnownLocation.latitude.toFixed(6)}, Lng: ${lastKnownLocation.longitude.toFixed(6)} - ${now.toLocaleTimeString()}`);
                }
            }, 2000); // Cada 2 segundos
            
            addLog('success', '‚è∞ Logger autom√°tico iniciado', 'Actualizaciones cada 2 segundos');
        }

        function stopLocationLogger() {
            if (locationLogger) {
                clearInterval(locationLogger);
                locationLogger = null;
                addLog('info', '‚èπÔ∏è Logger autom√°tico detenido');
            }
        }

        function sendLocation(position) {
            const coords = {
                device_id: deviceId,
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy,
                timestamp: new Date().toISOString(),
                name: deviceName,
                mac: deviceId
            };

            // Guardar la √∫ltima ubicaci√≥n conocida
            lastKnownLocation = {
                latitude: coords.latitude,
                longitude: coords.longitude,
                accuracy: coords.accuracy,
                timestamp: coords.timestamp
            };

            addLog('info', 'Ubicaci√≥n obtenida y enviada', 
                `Lat: ${coords.latitude.toFixed(6)}, Lng: ${coords.longitude.toFixed(6)}, Precisi√≥n: ¬±${coords.accuracy.toFixed(1)}m`);

            if (socket && socket.connected) {
                socket.emit('location_update', coords);
            } else {
                addLog('warning', 'Socket no conectado, no se pudo enviar ubicaci√≥n');
            }

            updateMyLocation(coords);
        }

        function updateMyLocation(coords) {
            myLocation.innerHTML = `
                <div class="coord-item"><strong>üü¢ Mi Dispositivo</strong></div>
                <div class="coord-item">üì±MAC: ${coords.mac || coords.device_id}</div>
                <div class="coord-item">üíª Nombre: ${coords.name}</div>
                <div class="coord-item">üìçLat: ${coords.latitude.toFixed(6)}</div>
                <div class="coord-item">üìç Lng: ${coords.longitude.toFixed(6)}</div>
                <div class="coord-item">üéØ Precisi√≥n: ¬±${coords.accuracy.toFixed(1)}m</div>
                <div class="coord-item">‚è∞ ${new Date(coords.timestamp).toLocaleTimeString()}</div>
            `;

            // Actualizar mi marcador
            if (myMarker) {
                map.removeLayer(myMarker);
            }
            myMarker = L.marker([coords.latitude, coords.longitude])
                .bindPopup(`
                    <b>üü¢ Mi Dispositivo</b><br>
                    <b>MAC:</b> ${coords.mac || coords.device_id}<br>
                    <b>Nombre:</b> ${coords.name}<br>
                    üìç ${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}<br>
                    üéØ Precisi√≥n: ¬±${coords.accuracy.toFixed(1)}m
                `)
                .addTo(map);
            
            map.setView([coords.latitude, coords.longitude], 13);
            addLog('success', 'Marcador actualizado en el mapa');
        }

        function updateMap(allCoords) {
            let updatedDevices = 0;
            let removedDevices = 0;
            
            // Obtener lista de device_ids actualmente en el servidor
            const activeDeviceIds = Object.keys(allCoords);
            
            // Eliminar marcadores de dispositivos que ya no est√°n activos
            Object.keys(markers).forEach(deviceId => {
                if (!activeDeviceIds.includes(deviceId)) {
                    map.removeLayer(markers[deviceId]);
                    delete markers[deviceId];
                    removedDevices++;
                    addLog('warning', `Dispositivo desconectado removido del mapa`, `MAC: ${deviceId}`);
                }
            });
            
            // Actualizar o agregar marcadores de dispositivos activos
            Object.values(allCoords).forEach(coords => {
                if (coords.device_id !== deviceId) {
                    if (markers[coords.device_id]) {
                        map.removeLayer(markers[coords.device_id]);
                    }
                    markers[coords.device_id] = L.marker([coords.latitude, coords.longitude])
                        .bindPopup(`
                            <b>üîµ Otro Dispositivo</b><br>
                            <b>MAC:</b> ${coords.mac || coords.device_id}<br>
                            <b>Nombre:</b> ${coords.name}<br>
                            üìç ${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}<br>
                            üéØ Precisi√≥n: ¬±${coords.accuracy.toFixed(1)}m<br>
                            ‚è∞ ${new Date(coords.timestamp).toLocaleTimeString()}
                        `)
                        .addTo(map);
                    updatedDevices++;
                }
            });
            
            if (updatedDevices > 0) {
                addLog('info', `Mapa actualizado con ${updatedDevices} dispositivos externos`);
            }
            if (removedDevices > 0) {
                addLog('info', `${removedDevices} dispositivos desconectados eliminados del mapa`);
            }
        }

        function updateDevicesList(allCoords) {
            const devices = Object.values(allCoords).filter(c => c.device_id !== deviceId);
            if (devices.length === 0) {
                devicesList.innerHTML = 'No hay otros dispositivos conectados';
            } else {
                devicesList.innerHTML = devices.map(device => `
                    <div class="coord-item">
                        <strong>üîπ ${device.name}</strong><br>
                        üì± MAC: ${device.mac || device.device_id}<br>
                        üìç ${device.latitude.toFixed(4)}, ${device.longitude.toFixed(4)}<br>
                        ‚è∞ ${new Date(device.timestamp).toLocaleTimeString()}
                    </div>
                `).join('');
                addLog('info', `Lista de dispositivos actualizada`, `${devices.length} dispositivos externos`);
            }
        }

        function handleLocationError(error) {
            let message = 'Error GPS: ';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message += 'Permisos denegados';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message += 'Posici√≥n no disponible';
                    break;
                case error.TIMEOUT:
                    message += 'Tiempo agotado';
                    break;
                default:
                    message += 'Error desconocido';
            }
            addLog('error', message, `C√≥digo de error: ${error.code}`);
            showMessage(statusDiv, message, 'error');
        }

        function stopGPSTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                addLog('info', 'Seguimiento GPS detenido');
            }
            // Detener el logger de ubicaci√≥n
            stopLocationLogger();
            lastKnownLocation = null;
            showMessage(statusDiv, 'üõë GPS tracking desactivado', 'info');
        }

        // Event listeners
        authForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const email = document.getElementById('email').value;
            
            if (isRegistering) {
                registerUser(username, password, email);
            } else {
                authenticate(username, password);
            }
        });

        authToggleLink.addEventListener('click', (e) => {
            e.preventDefault();
            toggleAuthMode();
        });

        logoutBtn.addEventListener('click', () => {
            if (socket) socket.disconnect();
            showLogin();
            showMessage(loginStatus, 'üëã Sesi√≥n cerrada', 'info');
        });

        // Inicializar log
        addLog('success', 'Sistema GPS Tracker iniciado');
        addLog('info', 'Esperando autenticaci√≥n del usuario...');
    </script>
</body>
</html>